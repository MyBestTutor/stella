<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>은수 주간 학습 플래너</title>
<style>
:root{
  --bg:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
  --brand:#5c7cfa; --ok:#72d6b1; --warn:#f7c87b; --danger:#ff8f7a; --border:#e6e9ef;
  --shadow:0 6px 18px rgba(15,23,42,.06);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0; padding:0; color:var(--ink); background:var(--bg);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",Arial;}
.header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.96); border-bottom:1px solid var(--border); backdrop-filter:saturate(180%) blur(6px)}
.container{max-width:1280px; margin:0 auto; padding:12px}
<h1>{margin:0; font-size:20px; letter-spacing:-.2px}
.sub{color:#475569; font-weight:800; font-size:12px}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px}
.btn{border:1px solid var(--border); background:#f7f8fd; color:#0f172a; padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:var(--shadow)}
.btn.primary{background:var(--brand); color:#fff; border-color:transparent}
.btn.success{background:var(--ok); color:#0f172a; border-color:transparent}
.btn.warn{background:var(--warn); color:#0f172a; border-color:transparent}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.badge{background:#eef2ff; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}
.tabs{display:flex; gap:6px; margin-left:auto}
.tab{padding:8px 12px; border-radius:999px; background:#f6f7fb; border:1px solid var(--border); color:#0f172a; font-weight:800; cursor:pointer; user-select:none}
.tab.active{background:var(--brand); color:#fff; border-color:transparent}
.hidden{display:none !important}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:visible}
.card .title{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); font-weight:900}
.card .body{padding:10px 12px}
.small{font-size:12px; color:var(--muted); font-variant-numeric: tabular-nums;}
.tiny{font-size:11px; color:#64748b}
.board{display:grid; grid-template-columns: 1fr 1.5fr; gap:12px; margin-top:12px}
@media (max-width: 1000px){ .board{grid-template-columns: 1fr} }
.board .col{display:flex; flex-direction:column; gap:12px}
/* Full-width calendar area */
.fullcal{margin-top:14px}
.calendar-wrap{overflow-x:auto; padding-bottom:4px}
.cal{display:grid; grid-template-columns: repeat(7, minmax(150px, 1fr)); gap:8px; min-width:990px}
.cell{border:1px solid var(--border); border-radius:10px; padding:8px; background:#fff; min-height:120px; display:flex; flex-direction:column; gap:6px; word-break:keep-all}
.cell .head{display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#334155; font-weight:700}
.cell .list{display:flex; flex-direction:column; gap:6px}
.tag{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:#fff; font-size:12px; white-space:nowrap}
.tag input[type="checkbox"]{transform:scale(1.1)}
.tag.done{background:#e8ffe8; border-color:#baf7c0}
.progress{font-size:11px; color:#64748b}
.table{width:100%; border-collapse:collapse}
.table th,.table td{border:1px solid var(--border); padding:8px; text-align:center; font-size:13px; vertical-align:top}
.table th{background:#f6f7fb}
.left{text-align:left}
.kbar{height:8px; background:#e8eefc; border-radius:999px; overflow:hidden}
.kbar>span{display:block; height:100%; background:var(--brand)}
.grid{display:grid; gap:10px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.tcard{padding:6px; border:1px solid var(--border); border-radius:12px; background:#fff}
.thead{display:flex; gap:6px; align-items:center; font-weight:900; font-size:12px}
.bar{height:6px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:4px}
.bar>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--ok))}
.info{font-size:11px; color:#64748b; margin-top:2px; font-variant-numeric: tabular-nums;}
.badges{display:flex; gap:6px; flex-wrap:wrap}
.badge-chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px}
/* Routine day toggle as button */
.daybtn{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none; background:#fff}
.daybtn.on{background:#eef2ff; border-color:#c7d2fe}
.daybtn:focus{outline:2px solid #c7d2fe; outline-offset:2px}
/* micro bars */
.minibar{height:6px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:4px}
.minibar>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--ok))}

/* NEW: inner pill tabs for Overdue card */
.pilltabs{display:flex; gap:6px; flex-wrap:wrap}
.pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f6f7fb; cursor:pointer; font-weight:800; font-size:12px}
.pill.active{background:var(--brand); color:#fff; border-color:transparent}
.sep{height:1px; background:var(--border); margin:8px 0}
</style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
        <h1>은수 주간 학습 플래너 <span class="sub">이번주도 화이팅!</span></h1>
        <span class="badge">이번 주: <span id="week-range"></span></span>
        <div class="tabs">
          <div class="tab active" data-action="tab:dashboard" tabindex="0">대시보드</div>
          <div class="tab" data-action="tab:exams" tabindex="0">시험 관리</div>
          <div class="tab" data-action="tab:routine" tabindex="0">일상 플래너</div>
        </div>
        <button class="btn primary" data-action="export">내보내기</button>
        <label class="btn success" for="import-file">불러오기</label>
        <input type="file" id="import-file" accept="application/json" style="display:none">
      </div>
    </div>
  </div>
  <!-- DASHBOARD -->
  <section id="view-dashboard">
    <div class="container">
      <div class="board">
        <!-- LEFT: 오늘 할 일 -->
        <div class="col">
          <div class="card">
            <div class="title">오늘 할 일 (시험+일상)</div>
            <div class="body" id="today-list"><div class="tiny">오늘로 배정된 항목이 여기에 표시됩니다.</div></div>
          </div>
          <!-- Weekly routine summary -->
          <div class="card">
            <div class="title">이번 주 일상 합계</div>
            <div class="body" id="weekly-summary">
              <div class="kbar"><span id="weekly-bar" style="width:0%"></span></div>
              <div class="small" id="weekly-text" style="margin-top:6px">배정 0 · 완료 0</div>
              <div id="weekly-list" style="margin-top:8px" class="grid grid-2"></div>
            </div>
          </div>
        </div>
        <!-- RIGHT: 시험 관련 -->
        <div class="col">
          <div class="card">
            <div class="title">오늘의 시험 대비</div>
            <div class="body">
              <div class="tcard">
                <div class="thead" id="hero-title">시험이 등록되지 않았어요</div>
                <div class="info" id="hero-sub">시험 관리에서 날짜별 과목/범위를 추가하세요.</div>
                <div class="bar" style="margin-top:6px"><span id="hero-progress" style="width:0%"></span></div>
              </div>
              <div class="grid grid-3" id="schedule-preview" style="margin-top:10px"></div>
            </div>
          </div>
          <div class="card">
            <div class="title">과목별 진행</div>
            <div class="body" id="subject-progress"></div>
          </div>
          <div class="card">
            <div class="title">전체 준비율</div>
            <div class="body">
              <div class="kbar"><span id="overall-bar" style="width:0%"></span></div>
              <div class="small" id="overall-text" style="margin-top:6px">0%</div>
              <div class="tiny">*전체 준비율은 시험 대비 할 일 기준이에요.</div>
            </div>
          </div>
          <div class="card">
            <div class="title">오늘 칭찬 뱃지</div>
            <div class="body">
              <div class="badges" id="today-badge-one"></div>
              <div class="small" id="today-stats" style="margin-top:6px">0/0 완료</div>
            </div>
          </div>
        </div>
      </div>
      <!-- FULL-WIDTH CALENDAR -->
      <div class="fullcal">
        <div class="card">
          <div class="title">달력 (오늘→시험 마지막 날) — 큰 화면</div>
          <div class="body">
            <div class="tiny">가로 공간이 부족하면 이 영역만 좌우 스크롤됩니다.</div>
            <div class="calendar-wrap">
              <div class="cal" id="calendar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- EXAMS -->
  <section id="view-exams" class="hidden">
    <div class="container">
      <div class="card">
        <div class="title">시험 일정 (행 단위: 날짜 · 과목들 · 범위)</div>
        <div class="body">
          <table class="table" id="schedule-table">
            <thead><tr><th>날짜</th><th class="left">과목들</th><th class="left">범위</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="btn-add-row">행 추가</button>
            <button class="btn" id="btn-clear-schedule">일정 비우기</button>
          </div>
          <div class="tiny" style="margin-top:6px">예) 12월4일 | 수학,국어 | 수학 1-2단원; 국어 3단원</div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">과목별 해야할 일 (행 추가/완료/날짜 배정)</div>
        <div class="body" id="todos-host">
          <div class="tiny">과목을 선택해 할 일을 한 줄씩 추가하고, 공부할 날짜를 지정하면 달력에 표시됩니다.</div>
          <div class="row" style="margin-top:6px">
            <select class="select" id="todo-subject"></select>
            <input class="select" id="todo-text" placeholder="할 일 내용 (예: 개념정리, 기출 1회)">
            <input type="date" id="todo-date">
            <button class="btn primary" id="btn-add-todo">추가</button>
          </div>
          <div id="todo-lists" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">일정 배정</div>
        <div class="body">
          <div class="row">
            <button class="btn success" id="btn-autoplan">🗓️ 오늘→시험 마지막 날 자동 분배</button>
            <button class="btn" id="btn-clearplan">배정 초기화</button>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn danger" id="btn-reset-all">모든 데이터 초기화</button>
          </div>
          </div>
      </div>
    </div>
  </section>
  <!-- ROUTINE (Everyday planner) -->
  <section id="view-routine" class="hidden">
    <div class="container">
      <div class="card">
        <div class="title">일상 과제 목록</div>
        <div class="body">
          <table class="table" id="routine-task-table">
            <thead><tr><th>과목</th><th class="left">제목</th><th>단위 분</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:6px">
            <input class="select" id="r-new-subj" placeholder="과목 (예: 영어)">
            <input class="select" id="r-new-title" placeholder="제목 (예: 단어 30개)">
            <input class="select" id="r-new-min" type="number" min="5" step="5" placeholder="분" style="width:120px">
            <button class="btn primary" id="r-btn-task-add">추가</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">요일별 배정 (on/off)</div>
        <div class="body">
          <table class="table" id="routine-plan-table">
            <thead>
              <tr><th class="left">과제</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th><th>주간 합계</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  <!-- SETTINGS -->
  <!-- 설정 섹션 제거됨 -->
<!-- section id="view-settings" class="hidden" -->
    <div class="container">
      </div>
      </div>
    </div>
  </section>
<script>
/* ===== Storage & Utils ===== */
const Store = { get(k){try{return localStorage.getItem(k)}catch(e){return null}}, set(k,v){try{localStorage.setItem(k,v)}catch(e){}} };
const KEYs=["midplanner:v6h","midplanner:v6e","midplanner:v6d","midplanner:v6c","midplanner:v6b","midplanner:v6a","midplanner:v6"];
const SAVE_KEY="midplanner:v6h";
function pad(n){return n<10? "0"+n: ""+n}
function fmtDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function getISOWeek(d){ const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum=date.getUTCDay()||7; date.setUTCDate(date.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7); return [date.getUTCFullYear(), weekNo]; }
function weekStartEnd(isoYear, isoWeek){ const simple=new Date(Date.UTC(isoYear,0,4)); const dayOfWeek=simple.getUTCDay()||7; const monday=new Date(simple); monday.setUTCDate(simple.getUTCDate()-dayOfWeek+1+(isoWeek-1)*7); const sunday=new Date(monday); sunday.setUTCDate(monday.getUTCDate()+6); return [monday, sunday]; }
function uid(){ return Math.random().toString(36).slice(2,10) }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
function dateToKDay(ds){
  const d = new Date(ds+"T00:00:00");
  return ["일","월","화","수","목","금","토"][d.getDay()];
}
function parseLocalDate(ds){
  const [y,m,d] = ds.split('-').map(Number);
  return new Date(y, (m||1)-1, d||1, 0,0,0,0);
}
function isBetweenDates(ds, start, end){
  try{
    const t = parseLocalDate(ds).getTime();
    const s = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
    const e = new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime();
    return t>=s && t<=e;
  }catch(e){ return false; }
}
/* ===== Model ===== */
let state={ schedule:[], subjects:[], todos:[], routine:null };
/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  ensureRewards();
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  document.getElementById('week-range').textContent = `${fmtDate(new Date(ws))} ~ ${fmtDate(new Date(we))}`;
  load(); migrateIfNeeded(state); if(!state.routine) seedRoutine();
  setTab('dashboard'); renderAll();
});
/* ===== Persistence ===== */
function load(){
  let raw=null;
  for(const k of KEYs){ raw = Store.get(k); if(raw){ try{ state=JSON.parse(raw); return; }catch(e){} } }
  state={schedule:[],subjects:[],todos:[],routine:null,rewards:null};
}
function save(){ Store.set(SAVE_KEY, JSON.stringify(state)); }
/* ===== Migration ===== */
function migrateIfNeeded(st){
  if(st && st.routine){
    const r=st.routine;
    if(!r.allocBool && r.alloc){
      r.allocBool={};
      (r.tasks||[]).forEach(t=>{
        r.allocBool[t.id] = {"월":false,"화":false,"수":false,"목":false,"금":false,"토":false,"일":false};
        const src = r.alloc?.[t.id];
        if(src){
          for(const d of Object.keys(r.allocBool[t.id])){
            r.allocBool[t.id][d] = (src[d]||0) > 0;
          }
        }
      });
    }
    if(!r.doneDates){ r.doneDates={}; }
    delete r.alloc; delete r.done; delete r.subjects;
  }
  if(!st.subjects) st.subjects=[];
  if(!st.schedule) st.schedule=[];
  if(!st.todos) st.todos=[];
  if(!st.rewards){
    st.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  } else {
    if(typeof st.rewards.badgeCount!=='number') st.rewards.badgeCount = parseInt(st.rewards.badgeCount)||0;
    if(!st.rewards.badgeDates) st.rewards.badgeDates = {};
    if(typeof st.rewards.coupons!=='number') st.rewards.coupons = parseInt(st.rewards.coupons)||0;
  }
}
/* ===== Tabs ===== */
function setTab(name){
  document.querySelectorAll('.tab').forEach(el=> el.classList.toggle('active', el.dataset.action==='tab:'+name));
  document.getElementById('view-dashboard').classList.toggle('hidden', name!=='dashboard');
  document.getElementById('view-exams').classList.toggle('hidden', name!=='exams');
  document.getElementById('view-routine').classList.toggle('hidden', name!=='routine');
  if(name==='dashboard') renderDashboard();
  if(name==='exams') renderScheduleEditor();
  if(name==='routine') renderRoutine();
}
document.body.addEventListener('click',(e)=>{
  const a=e.target.closest('[data-action]'); if(!a) return;
  const act=a.dataset.action;
  if(act?.startsWith('tab:')) setTab(act.split(':')[1]);
  if(act==='export'){
    const out = JSON.stringify(state, null, 2);
    const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([out],{type:"application/json"}));
    link.download = `midplanner_v6h_${new Date().toISOString().slice(0,10)}.json`; link.click();
  }
});
document.getElementById('import-file').addEventListener('change',(e)=>{
  if(!e.target.files?.length) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ state=JSON.parse(reader.result); migrateIfNeeded(state); save(); renderAll(); renderRoutine(); alert('불러오기 완료'); }catch(err){ alert('불러오기 실패: '+err.message);} };
  reader.readAsText(e.target.files[0]);
});
/* ===== Subjects registry (exam) ===== */
function ensureSubject(name){
  name=(name||'').trim(); if(!name) return null;
  let s=state.subjects.find(x=>x.name===name);
  if(!s){ s={id:uid(), name}; state.subjects.push(s); }
  return s.id;
}
function subjectNameById(id){ return state.subjects.find(s=>s.id===id)?.name || id; }
/* ===== Schedule Editor ===== */
function renderScheduleEditor(){
  const tbody=document.querySelector('#schedule-table tbody'); tbody.innerHTML='';
  if(state.schedule.length===0){
    const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="left">행을 추가해 날짜·과목·범위를 입력하세요.</td>`; tbody.appendChild(tr);
  }else{
    state.schedule.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    for(const row of state.schedule){
      const tr=document.createElement('tr');
      const tdDate=document.createElement('td'); tdDate.innerHTML=`<input type="date" value="${row.date||''}">`; 
      const tdSubs=document.createElement('td'); tdSubs.className='left';
      const tdRanges=document.createElement('td'); tdRanges.className='left';
      const tdAct=document.createElement('td');
      const subsWrap=document.createElement('div'); subsWrap.style.padding='0';
      const rangesWrap=document.createElement('div'); rangesWrap.style.padding='0';
      const redrawPairs=()=>{
        subsWrap.innerHTML=''; rangesWrap.innerHTML='';
        if(!row.entries) row.entries=[];
        if(row.entries.length===0){
          subsWrap.innerHTML='<div class="tiny">과목 추가</div>';
          rangesWrap.innerHTML='<div class="tiny">범위 입력</div>';
        }
        row.entries.forEach((p)=>{
          const line=document.createElement('div'); line.className='row'; line.style.margin='4px 0';
          line.innerHTML=`<input type="text" value="${escapeHtml(subjectNameById(p.sid))}" placeholder="과목">`;
          const del=document.createElement('button'); del.className='btn'; del.textContent='삭제';
          line.appendChild(del); subsWrap.appendChild(line);
          const rline=document.createElement('div'); rline.className='row'; rline.style.margin='4px 0';
          rline.innerHTML=`<input type="text" value="${escapeHtml(p.range||'')}" placeholder="예: ${subjectNameById(p.sid)} 1-2단원" style="flex:1">`;
          rangesWrap.appendChild(rline);
          const subjInput=line.querySelector('input[type="text"]');
          const rangeInput=rline.querySelector('input[type="text"]');
          subjInput.onchange=()=>{ const sid=ensureSubject(subjInput.value); if(sid) { p.sid=sid; save(); renderAll(); } };
          rangeInput.onchange=()=>{ p.range=rangeInput.value.trim(); save(); renderAll(); };
          del.onclick=()=>{ row.entries = row.entries.filter(x=>x!==p); save(); redrawPairs(); renderAll(); };
        });
      };
      redrawPairs();
      const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='과목 추가';
      addBtn.onclick=()=>{ row.entries.push({sid: ensureSubject(''), range:''}); save(); redrawPairs(); renderAll(); };
      tdSubs.appendChild(subsWrap); tdAct.appendChild(addBtn);
      tdRanges.appendChild(rangesWrap);
      const delRow=document.createElement('button'); delRow.className='btn danger'; delRow.textContent='행 삭제';
      delRow.onclick=()=>{ state.schedule = state.schedule.filter(x=>x!==row); save(); renderAll(); };
      tdAct.appendChild(delRow);
      tdDate.querySelector('input').onchange=(e)=>{ row.date=e.target.value; save(); renderAll(); };
      tr.appendChild(tdDate); tr.appendChild(tdSubs); tr.appendChild(tdRanges); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }
  }
  const sel=document.getElementById('todo-subject');
  sel.innerHTML = state.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
document.getElementById('btn-add-row').addEventListener('click', ()=>{
  state.schedule.push({id:uid(), date:'', entries:[]}); save(); renderAll();
});
document.getElementById('btn-clear-schedule').addEventListener('click', ()=>{
  if(!confirm('시험 일정을 모두 지울까요?')) return;
  state.schedule=[]; save(); renderAll();
});
/* ===== Todos CRUD (exam) ===== */
document.getElementById('btn-add-todo').addEventListener('click', ()=>{
  const sid=document.getElementById('todo-subject').value;
  const text=(document.getElementById('todo-text').value||'').trim();
  const date=document.getElementById('todo-date').value||null;
  if(!sid){ alert('과목을 선택하세요.'); return; }
  if(!text){ alert('할 일을 입력하세요.'); return; }
  state.todos.push({id:uid(), subjectId:sid, text, plannedDate:date, done:false});
  save(); document.getElementById('todo-text').value=''; document.getElementById('todo-date').value=''; renderAll();
});
function renderTodos(){
  const host=document.getElementById('todo-lists'); host.innerHTML='';
  if(state.subjects.length===0){ host.innerHTML='<div class="tiny">할 일이 없습니다. 일정에서 과목을 먼저 추가하세요.</div>'; return; }
  state.subjects.forEach(s=>{
    const list=state.todos.filter(t=>t.subjectId===s.id);
    const card=document.createElement('div'); card.className='tcard'; 
    const head=document.createElement('div'); head.className='thead'; head.textContent = `📝 ${s.name} (${list.filter(x=>x.done).length}/${list.length})`;
    const body=document.createElement('div'); body.className='body'; body.style.padding='6px 0 0';
    if(list.length===0){ body.innerHTML='<div class="tiny">할 일이 없습니다.</div>'; }
    list.forEach(t=>{
      const row=document.createElement('div'); row.className='tag'+(t.done?' done':'');
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=t.done; ck.onchange=()=>{ t.done=ck.checked; save(); renderDashboard(); };
      const txt=document.createElement('input'); txt.type='text'; txt.value=t.text; txt.style.flex='1';
      txt.onchange=()=>{ t.text=txt.value.trim(); save(); };
      const date=document.createElement('input'); date.type='date'; date.value=t.plannedDate||''; date.onchange=()=>{ t.plannedDate=date.value||null; save(); renderDashboard(); };
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='삭제'; del.onclick=()=>{ state.todos = state.todos.filter(x=>x!==t); save(); renderDashboard(); };
      row.appendChild(ck); row.appendChild(txt); row.appendChild(date); row.appendChild(del);
      body.appendChild(row);
    });
    card.appendChild(head); card.appendChild(body); host.appendChild(card);
  });
}
/* ===== Routine (Everyday planner) ===== */
function seedRoutine(){
  if(!state.rewards){ state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 }; }
  state.routine = {
    tasks:[
      {id:"rvocab",subject:"영어",title:"영단어 30개",unitMinutes:20},
      {id:"rmath",subject:"수학",title:"문제 2세트",unitMinutes:30}
    ],
    allocBool:{},
    doneDates:{}
  };
  state.routine.tasks.forEach(t=>{
    state.routine.allocBool[t.id] = {"월":true,"화":false,"수":true,"목":false,"금":true,"토":false,"일":false};
    state.routine.doneDates[t.id] = {};
  });
  save();
}
function ensureAllocBool(taskId){
  if(!state.routine.allocBool) state.routine.allocBool={};
  if(!state.routine.allocBool[taskId]) state.routine.allocBool[taskId]={"월":false,"화":false,"수":false,"목":false,"금":false,"토":false,"일":false};
}
function ensureDoneDates(taskId){
  if(!state.routine.doneDates) state.routine.doneDates={};
  if(!state.routine.doneDates[taskId]) state.routine.doneDates[taskId]={};
}
function renderRoutine(){
  renderRoutineTasks();
  renderRoutinePlan();
}
function renderRoutineTasks(){
  const tbody=document.querySelector('#routine-task-table tbody'); tbody.innerHTML='';
  state.routine.tasks.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.subject}</td><td class="left">${t.title}</td><td>${t.unitMinutes}</td>`;
    const td=document.createElement('td');
    const edit=document.createElement('button'); edit.className='btn'; edit.textContent='수정';
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='삭제'; del.style.marginLeft='6px';
    edit.onclick=()=>{
      const ns=prompt('과목', t.subject); if(ns===null) return;
      const nt=prompt('제목', t.title); if(nt===null) return;
      const um=prompt('단위 분', t.unitMinutes); if(um===null) return;
      t.subject=ns||t.subject; t.title=nt||t.title; t.unitMinutes=parseInt(um)||t.unitMinutes; save(); renderRoutine(); renderDashboard();
    };
    del.onclick=()=>{
      if(state.routine.allocBool) delete state.routine.allocBool[t.id];
      if(state.routine.doneDates) delete state.routine.doneDates[t.id];
      state.routine.tasks = state.routine.tasks.filter(x=>x!==t); save(); renderRoutine(); renderDashboard();
    };
    td.appendChild(edit); td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
  });
}
document.getElementById('r-btn-task-add').addEventListener('click', ()=>{
  const subject=(document.getElementById('r-new-subj').value||'').trim();
  const title=(document.getElementById('r-new-title').value||'').trim();
  const unitMinutes=parseInt(document.getElementById('r-new-min').value)||20;
  if(!subject||!title){ alert('과목/제목을 입력하세요.'); return; }
  const id='r_'+uid();
  const t={id, subject, title, unitMinutes};
  state.routine.tasks.push(t);
  ensureAllocBool(id); ensureDoneDates(id);
  save(); renderRoutine(); renderDashboard();
  document.getElementById('r-new-subj').value=''; document.getElementById('r-new-title').value=''; document.getElementById('r-new-min').value='';
});
function renderRoutinePlan(){
  const tbody=document.querySelector('#routine-plan-table tbody'); tbody.innerHTML='';
  const days=["월","화","수","목","금","토","일"];
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  state.routine.tasks.forEach(t=>{
    ensureAllocBool(t.id); ensureDoneDates(t.id);
    const tr=document.createElement('tr');
    const tdTask=document.createElement('td'); tdTask.className='left'; tdTask.innerHTML=`<strong>${t.title}</strong> <span class="small">(${t.subject} · ${t.unitMinutes}분)</span>`;
    tr.appendChild(tdTask);
    let assigned=0;
    days.forEach(d=>{
      const td=document.createElement('td');
      const on = !!state.routine.allocBool[t.id][d];
      if(on) assigned++;
      const btn=document.createElement('button');
      btn.type='button'; btn.className='daybtn'+(on?' on':''); btn.textContent= on ? '배정됨' : '배정 안함';
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.onclick=()=>{ state.routine.allocBool[t.id][d] = !on; save(); renderRoutine(); renderDashboard(); };
      btn.onkeydown=(ev)=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); btn.click(); } };
      td.appendChild(btn); tr.appendChild(td);
    });
    let doneCount=0;
    const doneMap = state.routine.doneDates[t.id] || {};
    Object.keys(doneMap).forEach(ds=>{
      if(doneMap[ds] && isBetweenDates(ds, ws, we)){
        const kd = dateToKDay(ds);
        if(state.routine.allocBool[t.id][kd]) doneCount++;
      }
    });
    const tdSum=document.createElement('td');
    const pct = assigned>0 ? Math.round((doneCount/assigned)*100) : 0;
    tdSum.innerHTML = `<div class="small">배정 ${assigned} · 완료 ${doneCount}</div><div class="minibar"><span style="width:${pct}%"></span></div>`;
    tr.appendChild(tdSum);
    tbody.appendChild(tr);
  });
}
/* ===== Dashboard ===== */
function renderDashboard(){
  const hero=document.getElementById('hero-title');
  const heroSub=document.getElementById('hero-sub');
  const heroBar=document.getElementById('hero-progress');
  const preview=document.getElementById('schedule-preview'); preview.innerHTML='';
  if(state.schedule.length===0){
    hero.textContent='시험이 등록되지 않았어요';
    heroSub.textContent='시험 관리에서 날짜별 과목/범위를 추가하세요.';
    heroBar.style.width='0%';
  }else{
    const dates = [...new Set(state.schedule.map(r=>r.date).filter(Boolean))].sort();
    const last = dates[dates.length-1];
    const d = dday(last);
    hero.textContent = `시험 D-${d}`;
    heroSub.textContent = `일정: ${dates.join(' · ')}`;
    const p = overallProgress();
    heroBar.style.width = Math.round(p)+'%';
    state.schedule.forEach(r=>{
      const card=document.createElement('div'); card.className='tcard';
      const head=document.createElement('div'); head.className='thead'; head.textContent = `${r.date}`;
      const body=document.createElement('div'); body.className='info';
      if(!r.entries || r.entries.length===0){ body.textContent='과목 없음'; }
      else{
        body.innerHTML = r.entries.map(e=>{
          const name = subjectNameById(e.sid);
          const rg = e.range? ` ${e.range}`:'';
          return `${name}${rg? ' · '+rg: ''}`;
        }).join('<br>');
      }
      card.appendChild(head); card.appendChild(body); preview.appendChild(card);
    });
  }
  renderSubjectProgress();
  renderCalendar();
  renderTodayList();
  renderOverall();
  renderTodayBadgeOne();
  renderWeeklySummaryCard();
  // Overdue card render (left column)
  (function(){
    const leftCol = document.querySelector('#view-dashboard .board .col');
    if(leftCol){
      const prev = document.getElementById('card-overdue');
      if(prev) prev.remove();
      leftCol.appendChild(renderOverdueList());
    }
  })();

}
function dday(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((d - today)/(1000*60*60*24));
  return diff>0? diff : 0;
}
function renderSubjectProgress(){
  const host=document.getElementById('subject-progress'); host.innerHTML='';
  if(state.subjects.length===0){ host.innerHTML='<div class="tiny">과목이 없습니다.</div>'; return; }
  state.subjects.forEach(s=>{
    const list=state.todos.filter(t=>t.subjectId===s.id);
    const total=list.length; const done=list.filter(t=>t.done).length; const pct= total? Math.round(done/total*100):0;
    const card=document.createElement('div'); card.className='tcard';
    const head=document.createElement('div'); head.className='thead'; head.textContent=`🎯 ${s.name}`;
    const bar=document.createElement('div'); bar.className='bar'; const span=document.createElement('span'); span.style.width=pct+'%'; bar.appendChild(span);
    const info=document.createElement('div'); info.className='info'; info.textContent=`${done}/${total} (${pct}%)`;
    card.appendChild(head); card.appendChild(bar); card.appendChild(info); host.appendChild(card);
  });
}
function renderCalendar(){
  const host=document.getElementById('calendar'); host.innerHTML='';
  const dates = [...new Set(state.schedule.map(r=>r.date).filter(Boolean))].sort();
  if(dates.length===0){ host.innerHTML='<div class="tiny">시험 일정이 없습니다.</div>'; return; }
  const today = new Date(); today.setHours(0,0,0,0);
  const end = new Date(dates[dates.length-1]+"T00:00:00");
  if(end<today){ host.innerHTML='<div class="tiny">마지막 시험일이 오늘보다 이전입니다.</div>'; return; }
  const days=[]; for(let d=new Date(today); d<=end; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ days.push(fmtDate(d)); }
  const map={}; days.forEach(k=> map[k]=[]);
  state.todos.forEach(t=>{ if(t.plannedDate && map[t.plannedDate]!==undefined) map[t.plannedDate].push({label:`${subjectNameById(t.subjectId)} · ${t.text}`, done:t.done, onToggle:(v)=>{ t.done=v; save(); renderDashboard(); }}); });
  days.forEach(date=>{
    const cell=document.createElement('div'); cell.className='cell';
    const head=document.createElement('div'); head.className='head';
    const cntDone=(map[date]||[]).filter(x=>x.done).length; const cntTotal=(map[date]||[]).length;
    head.innerHTML=`<span>${date}</span><span class="tiny">${cntDone}/${cntTotal}</span>`;
    const list=document.createElement('div'); list.className='list';
    (map[date]||[]).forEach(item=>{
      const row=document.createElement('label'); row.className='tag'+(item.done?' done':'');
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=item.done; ck.onchange=()=> item.onToggle(ck.checked);
      const txt=document.createElement('span'); txt.textContent = item.label;
      row.appendChild(ck); row.appendChild(txt); list.appendChild(row);
    });
    cell.appendChild(head); cell.appendChild(list); host.appendChild(cell);
  });
}
function renderTodayList(){
  const host=document.getElementById('today-list'); host.innerHTML='';
  const today=fmtDate(new Date());
  const todayName=["일","월","화","수","목","금","토"][new Date().getDay()];
  let count=0;
  // exam todos today
  state.todos.filter(t=>t.plannedDate===today).forEach(t=>{
    const row=document.createElement('label'); row.className='tag'+(t.done?' done':'');
    const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=t.done; ck.onchange=()=>{ t.done=ck.checked; save(); renderDashboard(); };
    const txt=document.createElement('span'); txt.textContent = `${subjectNameById(t.subjectId)} · ${t.text}`;
    row.appendChild(ck); row.appendChild(txt); host.appendChild(row); count++;
  });
  // routine tasks today
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const on = state.routine.allocBool[t.id][todayName];
      if(on){
        const done = !!state.routine.doneDates[t.id][today];
        const row=document.createElement('label'); row.className='tag'+(done?' done':'');
        const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=done;
        ck.onchange=()=>{ state.routine.doneDates[t.id][today]=ck.checked; save(); renderDashboard(); };
        const txt=document.createElement('span'); txt.textContent = `${t.subject} · ${t.title}`;
        row.appendChild(ck); row.appendChild(txt); host.appendChild(row); count++;
      }
    });
  }
  if(count===0){ host.innerHTML='<div class="tiny">오늘로 배정된 항목이 없습니다.</div>'; }
}
function overallProgress(){
  const total=state.todos.length; const done=state.todos.filter(t=>t.done).length;
  return total? (done/total*100) : 0;
}
function renderOverall(){
  const p=overallProgress();
  document.getElementById('overall-bar').style.width=Math.round(p)+'%';
  document.getElementById('overall-text').textContent = `전체 준비율 ${Math.round(p)}%`;
}

function renderTodayBadgeOne(){ ensureRewards(); 
  const host=document.getElementById('today-badge-one'); /*REWARD_TITLE_HOOK*/ host.innerHTML='';
  const stats=document.getElementById('today-stats');
  const today=fmtDate(new Date());
  const todayName=["일","월","화","수","목","금","토"][new Date().getDay()];
  let total=0, done=0;
  // count today's exam todos
  state.todos.filter(t=>t.plannedDate===today).forEach(t=>{ total++; if(t.done) done++; });
  // count today's routine
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const on=state.routine.allocBool[t.id][todayName];
      if(on){ total++; if(state.routine.doneDates[t.id][today]) done++; }
    });
  }
  stats.textContent = `${done}/${total} 완료`;

  // initialize rewards if absent
  if(!state.rewards){
    state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  }

  // If all done today (and at least one exists) and not already rewarded, add a badge
  const achievedToday = (total>0 && done===total);
  if(achievedToday && !state.rewards.badgeDates[today]){
    state.rewards.badgeDates[today] = true;
    state.rewards.badgeCount += 1;
    // Every 50 badges -> 1 coupon
    if(state.rewards.badgeCount % 50 === 0){
      state.rewards.coupons += 1;
      // celebratory chip
      const chip=document.createElement('div'); chip.className='badge-chip'; chip.textContent='🎉 프리데이 쿠폰 +1';
      host.appendChild(chip);
    }
    save();
  }

  // Stage-based single badge (visual feedback for today)
  let badgeText = "";
  if(total>0 && done===total) badgeText = "🏆 오늘 목표 100% 달성";
  else if(done>=5) badgeText = "🚀 5개 완료!";
  else if(done>=3) badgeText = "💪 3개 돌파";
  else if(done>=1) badgeText = "👏 1개 시작";
  if(badgeText){
    const d=document.createElement('div'); d.className='badge-chip'; d.textContent=badgeText; host.appendChild(d);
  }

  // Persistent counters row (badges & coupons)
  const counter = document.createElement('div');
  counter.className='small';
  counter.style.marginTop='8px';
  counter.textContent = `누적 칭찬뱃지 ${state.rewards.badgeCount}개 · 프리데이 쿠폰 ${state.rewards.coupons}장`;
  host.appendChild(counter);

  // Coupon use button
  const btnWrap = document.createElement('div');
  btnWrap.style.marginTop='6px';
  const useBtn = document.createElement('button');
  useBtn.className = 'btn ' + (state.rewards.coupons>0 ? 'warn' : '');
  useBtn.disabled = state.rewards.coupons<=0;
  useBtn.textContent = state.rewards.coupons>0 ? '🎫 프리데이 쿠폰 사용' : '쿠폰 없음';
  useBtn.onclick = ()=>{
    if(state.rewards.coupons>0){
      if(confirm('프리데이 쿠폰 1장을 사용할까요?')){
        state.rewards.coupons -= 1;
        save();
        renderTodayBadgeOne();
        alert('쿠폰 1장을 사용했어요!');
      }
    }
  };
  btnWrap.appendChild(useBtn);
  host.appendChild(btnWrap);

}
function renderWeeklySummaryCard(){
  const bar=document.getElementById('weekly-bar');
  const txt=document.getElementById('weekly-text');
  const list=document.getElementById('weekly-list');
  list.innerHTML='';
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  const days=["월","화","수","목","금","토","일"];
  let totalAssigned=0, totalDone=0;
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const assigned = days.reduce((acc,d)=> acc + (state.routine.allocBool[t.id][d]?1:0), 0);
      totalAssigned += assigned;
      let done=0;
      const dm = state.routine.doneDates[t.id] || {};
      Object.keys(dm).forEach(ds=>{
        if(dm[ds] && isBetweenDates(ds, ws, we)){
          const kd = dateToKDay(ds);
          if(state.routine.allocBool[t.id][kd]) done++;
        }
      });
      totalDone += done;
      const card=document.createElement('div'); card.className='tcard';
      const head=document.createElement('div'); head.className='thead'; head.textContent = `${t.subject} · ${t.title}`;
      const info=document.createElement('div'); info.className='info'; info.textContent = `배정 ${assigned} · 완료 ${done}`;
      const pct = assigned>0 ? Math.round((done/assigned)*100) : 0;
      const barMini=document.createElement('div'); barMini.className='minibar'; const span=document.createElement('span'); span.style.width=pct+'%'; barMini.appendChild(span);
      card.appendChild(head); card.appendChild(info); card.appendChild(barMini);
      list.appendChild(card);
    });
  }
  const pctAll = totalAssigned>0 ? Math.round((totalDone/totalAssigned)*100) : 0;
  bar.style.width = pctAll+'%';
  txt.textContent = `배정 ${totalAssigned} · 완료 ${totalDone}`;
}

/* ========= NEW: Overdue (시험+일상) 탭 통합 ========= */
function renderOverdueList(){
  const card=document.createElement('div');
  card.className='card';
  card.id='card-overdue';
  const title=document.createElement('div');
  title.className='title';

  const today=fmtDate(new Date());
  // 1) 시험 overdue (plannedDate < today && !done)
  const examOverdue=state.todos
    .filter(t=>t.plannedDate && t.plannedDate<today && !t.done)
    .sort((a,b)=> (a.plannedDate||'').localeCompare(b.plannedDate||''));

  // 2) 일상 overdue (이번 주 월요일~어제 사이의 배정 on인데 done 없음)
  const routineOverdue=[];
  if(state.routine){
    const days=["월","화","수","목","금","토","일"];
    const now=new Date();
    const [y,w]=getISOWeek(now);
    const [ws,we]=weekStartEnd(y,w); // ws = 월요일(UTC 기준) → 로컬 보정 위해 그대로 날짜 문자열만 사용

    // 해당 주의 각 요일 날짜 문자열 매핑
    const dayToDate={};
    for(let i=0;i<7;i++){
      const d=new Date(ws); d.setUTCDate(ws.getUTCDate()+i);
      dayToDate[days[i]] = fmtDate(new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    }
    const todayIdx = ["일","월","화","수","목","금","토"][now.getDay()];
    const idxOf = (nm)=> days.indexOf(nm);
    const cutoff = idxOf(todayIdx); // 오늘 이전만

    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      for(let i=0;i<cutoff;i++){
        const kday=days[i];
        if(state.routine.allocBool[t.id][kday]){
          const ds=dayToDate[kday];
          const done = !!state.routine.doneDates[t.id][ds];
          if(!done){
            routineOverdue.push({
              taskId:t.id,
              label:`${t.subject} · ${t.title}`,
              plannedDate: ds,
              kday: kday
            });
          }
        }
      }
    });
    routineOverdue.sort((a,b)=> a.plannedDate.localeCompare(b.plannedDate));
  }

  const totalCount = examOverdue.length + routineOverdue.length;
  title.innerHTML = `⏰ 밀린 할 일 ${totalCount? `<span class="badge">${totalCount}건</span>`:''}`;
  const body=document.createElement('div');
  body.className='body';

  // 탭 버튼
  const pills=document.createElement('div'); pills.className='pilltabs';
  const pExam=document.createElement('button'); pExam.type='button'; pExam.className='pill active'; pExam.textContent = `시험 (${examOverdue.length})`;
  const pRoutine=document.createElement('button'); pRoutine.type='button'; pRoutine.className='pill'; pRoutine.textContent = `일상 (${routineOverdue.length})`;
  pills.appendChild(pExam); pills.appendChild(pRoutine);
  body.appendChild(pills);
  body.appendChild(document.createElement('div')).className='sep';

  // 컨테이너
  const listWrap=document.createElement('div');
  body.appendChild(listWrap);

  function renderTab(which){
    listWrap.innerHTML='';
    const arr = which==='exam' ? examOverdue : routineOverdue;
    if(arr.length===0){ listWrap.innerHTML = '<div class="tiny">밀린 항목이 없습니다.</div>'; return; }
    arr.forEach(item=>{
      const row=document.createElement('label'); row.className='tag';
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=false;
      const span=document.createElement('span');
      if(which==='exam'){
        const subj = subjectNameById(item.subjectId);
        span.textContent = `${subj} · ${item.text} (${item.plannedDate})`;
        ck.onchange=()=>{ item.done=true; const t=state.todos.find(x=>x.id===item.id || (x.subjectId===item.subjectId && x.text===item.text && x.plannedDate===item.plannedDate)); if(t){ t.done=true; save(); renderDashboard(); } };
      }else{
        span.textContent = `${item.label} (${item.kday} · ${item.plannedDate})`;
        ck.onchange=()=>{ const m = state.routine.doneDates[item.taskId]||{}; m[item.plannedDate]=true; state.routine.doneDates[item.taskId]=m; save(); renderDashboard(); };
      }
      row.appendChild(ck); row.appendChild(span); listWrap.appendChild(row);
    });
  }
  renderTab('exam');
  pExam.onclick=()=>{ pExam.classList.add('active'); pRoutine.classList.remove('active'); renderTab('exam'); };
  pRoutine.onclick=()=>{ pRoutine.classList.add('active'); pExam.classList.remove('active'); renderTab('routine'); };

  card.appendChild(title);
  card.appendChild(body);
  return card;
}

/* ===== Settings ===== */
/* ===== Helpers ===== */

function ensureRewards(){
  if(!state.rewards || typeof state.rewards!=='object'){
    state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  }
  if(typeof state.rewards.badgeCount!=='number' || isNaN(state.rewards.badgeCount)) state.rewards.badgeCount = 0;
  if(!state.rewards.badgeDates || typeof state.rewards.badgeDates!=='object') state.rewards.badgeDates = {};
  if(typeof state.rewards.coupons!=='number' || isNaN(state.rewards.coupons)) state.rewards.coupons = 0;
}

function dday(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((d - today)/(1000*60*60*24));
  return diff>0? diff : 0;
}
function renderAll(){ ensureRewards();  renderScheduleEditor(); renderTodos(); renderDashboard(); }

// attach reset handler if button exists (exams page only)
(function(){
  const __resetBtn = document.getElementById('btn-reset-all');
  if(__resetBtn){
    __resetBtn.addEventListener('click', ()=>{
      if(!confirm('모든 데이터를 삭제할까요?')) return;
      KEYs.forEach(k=> localStorage.removeItem(k));
      state={schedule:[], subjects:[], todos:[], routine:null}; seedRoutine(); renderAll();
    });
  }
})();
</script>
</body>
</html>

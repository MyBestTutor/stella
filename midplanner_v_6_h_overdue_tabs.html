<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ì€ìˆ˜ ì£¼ê°„ í•™ìŠµ í”Œë˜ë„ˆ</title>
<style>
:root{
  --bg:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
  --brand:#5c7cfa; --ok:#72d6b1; --warn:#f7c87b; --danger:#ff8f7a; --border:#e6e9ef;
  --shadow:0 6px 18px rgba(15,23,42,.06);
  --radius:16px;
}
*{box-sizing:border-box}
html,body{margin:0; padding:0; color:var(--ink); background:var(--bg);
  font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR","Apple SD Gothic Neo","Malgun Gothic",Arial;}
.header{position:sticky; top:0; z-index:20; background:rgba(255,255,255,.96); border-bottom:1px solid var(--border); backdrop-filter:saturate(180%) blur(6px)}
.container{max-width:1280px; margin:0 auto; padding:12px}
<h1>{margin:0; font-size:20px; letter-spacing:-.2px}
.sub{color:#475569; font-weight:800; font-size:12px}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:4px}
.btn{border:1px solid var(--border); background:#f7f8fd; color:#0f172a; padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; box-shadow:var(--shadow)}
.btn.primary{background:var(--brand); color:#fff; border-color:transparent}
.btn.success{background:var(--ok); color:#0f172a; border-color:transparent}
.btn.warn{background:var(--warn); color:#0f172a; border-color:transparent}
.btn.danger{background:var(--danger); color:#fff; border-color:transparent}
.badge{background:#eef2ff; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}
.tabs{display:flex; gap:6px; margin-left:auto}
.tab{padding:8px 12px; border-radius:999px; background:#f6f7fb; border:1px solid var(--border); color:#0f172a; font-weight:800; cursor:pointer; user-select:none}
.tab.active{background:var(--brand); color:#fff; border-color:transparent}
.hidden{display:none !important}
.card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:visible}
.card .title{display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--border); font-weight:900}
.card .body{padding:10px 12px}
.small{font-size:12px; color:var(--muted); font-variant-numeric: tabular-nums;}
.tiny{font-size:11px; color:#64748b}
.board{display:grid; grid-template-columns: 1fr 1.5fr; gap:12px; margin-top:12px}
@media (max-width: 1000px){ .board{grid-template-columns: 1fr} }
.board .col{display:flex; flex-direction:column; gap:12px}
/* Full-width calendar area */
.fullcal{margin-top:14px}
.calendar-wrap{overflow-x:auto; padding-bottom:4px}
.cal{display:grid; grid-template-columns: repeat(7, minmax(150px, 1fr)); gap:8px; min-width:990px}
.cell{border:1px solid var(--border); border-radius:10px; padding:8px; background:#fff; min-height:120px; display:flex; flex-direction:column; gap:6px; word-break:keep-all}
.cell .head{display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#334155; font-weight:700}
.cell .list{display:flex; flex-direction:column; gap:6px}
.tag{display:flex; align-items:center; gap:6px; padding:6px 8px; border-radius:8px; border:1px solid var(--border); background:#fff; font-size:12px; white-space:nowrap}
.tag input[type="checkbox"]{transform:scale(1.1)}
.tag.done{background:#e8ffe8; border-color:#baf7c0}
.progress{font-size:11px; color:#64748b}
.table{width:100%; border-collapse:collapse}
.table th,.table td{border:1px solid var(--border); padding:8px; text-align:center; font-size:13px; vertical-align:top}
.table th{background:#f6f7fb}
.left{text-align:left}
.kbar{height:8px; background:#e8eefc; border-radius:999px; overflow:hidden}
.kbar>span{display:block; height:100%; background:var(--brand)}
.grid{display:grid; gap:10px}
.grid-2{grid-template-columns:1fr 1fr}
.grid-3{grid-template-columns:1fr 1fr 1fr}
.tcard{padding:6px; border:1px solid var(--border); border-radius:12px; background:#fff}
.thead{display:flex; gap:6px; align-items:center; font-weight:900; font-size:12px}
.bar{height:6px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:4px}
.bar>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--ok))}
.info{font-size:11px; color:#64748b; margin-top:2px; font-variant-numeric: tabular-nums;}
.badges{display:flex; gap:6px; flex-wrap:wrap}
.badge-chip{display:inline-flex; align-items:center; gap:6px; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:#fff; font-size:12px}
/* Routine day toggle as button */
.daybtn{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; cursor:pointer; user-select:none; background:#fff}
.daybtn.on{background:#eef2ff; border-color:#c7d2fe}
.daybtn:focus{outline:2px solid #c7d2fe; outline-offset:2px}
/* micro bars */
.minibar{height:6px; border-radius:999px; background:#e5e7eb; overflow:hidden; margin-top:4px}
.minibar>span{display:block; height:100%; background:linear-gradient(90deg, var(--brand), var(--ok))}

/* NEW: inner pill tabs for Overdue card */
.pilltabs{display:flex; gap:6px; flex-wrap:wrap}
.pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#f6f7fb; cursor:pointer; font-weight:800; font-size:12px}
.pill.active{background:var(--brand); color:#fff; border-color:transparent}
.sep{height:1px; background:var(--border); margin:8px 0}
</style>
</head>
<body>
  <div class="header">
    <div class="container">
      <div class="row">
        <h1>ì€ìˆ˜ ì£¼ê°„ í•™ìŠµ í”Œë˜ë„ˆ <span class="sub">ì´ë²ˆì£¼ë„ í™”ì´íŒ…!</span></h1>
        <span class="badge">ì´ë²ˆ ì£¼: <span id="week-range"></span></span>
        <div class="tabs">
          <div class="tab active" data-action="tab:dashboard" tabindex="0">ëŒ€ì‹œë³´ë“œ</div>
          <div class="tab" data-action="tab:exams" tabindex="0">ì‹œí—˜ ê´€ë¦¬</div>
          <div class="tab" data-action="tab:routine" tabindex="0">ì¼ìƒ í”Œë˜ë„ˆ</div>
        </div>
        <button class="btn primary" data-action="export">ë‚´ë³´ë‚´ê¸°</button>
        <label class="btn success" for="import-file">ë¶ˆëŸ¬ì˜¤ê¸°</label>
        <input type="file" id="import-file" accept="application/json" style="display:none">
      </div>
    </div>
  </div>
  <!-- DASHBOARD -->
  <section id="view-dashboard">
    <div class="container">
      <div class="board">
        <!-- LEFT: ì˜¤ëŠ˜ í•  ì¼ -->
        <div class="col">
          <div class="card">
            <div class="title">ì˜¤ëŠ˜ í•  ì¼ (ì‹œí—˜+ì¼ìƒ)</div>
            <div class="body" id="today-list"><div class="tiny">ì˜¤ëŠ˜ë¡œ ë°°ì •ëœ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div></div>
          </div>
          <!-- Weekly routine summary -->
          <div class="card">
            <div class="title">ì´ë²ˆ ì£¼ ì¼ìƒ í•©ê³„</div>
            <div class="body" id="weekly-summary">
              <div class="kbar"><span id="weekly-bar" style="width:0%"></span></div>
              <div class="small" id="weekly-text" style="margin-top:6px">ë°°ì • 0 Â· ì™„ë£Œ 0</div>
              <div id="weekly-list" style="margin-top:8px" class="grid grid-2"></div>
            </div>
          </div>
        </div>
        <!-- RIGHT: ì‹œí—˜ ê´€ë ¨ -->
        <div class="col">
          <div class="card">
            <div class="title">ì˜¤ëŠ˜ì˜ ì‹œí—˜ ëŒ€ë¹„</div>
            <div class="body">
              <div class="tcard">
                <div class="thead" id="hero-title">ì‹œí—˜ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”</div>
                <div class="info" id="hero-sub">ì‹œí—˜ ê´€ë¦¬ì—ì„œ ë‚ ì§œë³„ ê³¼ëª©/ë²”ìœ„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</div>
                <div class="bar" style="margin-top:6px"><span id="hero-progress" style="width:0%"></span></div>
              </div>
              <div class="grid grid-3" id="schedule-preview" style="margin-top:10px"></div>
            </div>
          </div>
          <div class="card">
            <div class="title">ê³¼ëª©ë³„ ì§„í–‰</div>
            <div class="body" id="subject-progress"></div>
          </div>
          <div class="card">
            <div class="title">ì „ì²´ ì¤€ë¹„ìœ¨</div>
            <div class="body">
              <div class="kbar"><span id="overall-bar" style="width:0%"></span></div>
              <div class="small" id="overall-text" style="margin-top:6px">0%</div>
              <div class="tiny">*ì „ì²´ ì¤€ë¹„ìœ¨ì€ ì‹œí—˜ ëŒ€ë¹„ í•  ì¼ ê¸°ì¤€ì´ì—ìš”.</div>
            </div>
          </div>
          <div class="card">
            <div class="title">ì˜¤ëŠ˜ ì¹­ì°¬ ë±ƒì§€</div>
            <div class="body">
              <div class="badges" id="today-badge-one"></div>
              <div class="small" id="today-stats" style="margin-top:6px">0/0 ì™„ë£Œ</div>
            </div>
          </div>
        </div>
      </div>
      <!-- FULL-WIDTH CALENDAR -->
      <div class="fullcal">
        <div class="card">
          <div class="title">ë‹¬ë ¥ (ì˜¤ëŠ˜â†’ì‹œí—˜ ë§ˆì§€ë§‰ ë‚ ) â€” í° í™”ë©´</div>
          <div class="body">
            <div class="tiny">ê°€ë¡œ ê³µê°„ì´ ë¶€ì¡±í•˜ë©´ ì´ ì˜ì—­ë§Œ ì¢Œìš° ìŠ¤í¬ë¡¤ë©ë‹ˆë‹¤.</div>
            <div class="calendar-wrap">
              <div class="cal" id="calendar"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- EXAMS -->
  <section id="view-exams" class="hidden">
    <div class="container">
      <div class="card">
        <div class="title">ì‹œí—˜ ì¼ì • (í–‰ ë‹¨ìœ„: ë‚ ì§œ Â· ê³¼ëª©ë“¤ Â· ë²”ìœ„)</div>
        <div class="body">
          <table class="table" id="schedule-table">
            <thead><tr><th>ë‚ ì§œ</th><th class="left">ê³¼ëª©ë“¤</th><th class="left">ë²”ìœ„</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:6px">
            <button class="btn primary" id="btn-add-row">í–‰ ì¶”ê°€</button>
            <button class="btn" id="btn-clear-schedule">ì¼ì • ë¹„ìš°ê¸°</button>
          </div>
          <div class="tiny" style="margin-top:6px">ì˜ˆ) 12ì›”4ì¼ | ìˆ˜í•™,êµ­ì–´ | ìˆ˜í•™ 1-2ë‹¨ì›; êµ­ì–´ 3ë‹¨ì›</div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">ê³¼ëª©ë³„ í•´ì•¼í•  ì¼ (í–‰ ì¶”ê°€/ì™„ë£Œ/ë‚ ì§œ ë°°ì •)</div>
        <div class="body" id="todos-host">
          <div class="tiny">ê³¼ëª©ì„ ì„ íƒí•´ í•  ì¼ì„ í•œ ì¤„ì”© ì¶”ê°€í•˜ê³ , ê³µë¶€í•  ë‚ ì§œë¥¼ ì§€ì •í•˜ë©´ ë‹¬ë ¥ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          <div class="row" style="margin-top:6px">
            <select class="select" id="todo-subject"></select>
            <input class="select" id="todo-text" placeholder="í•  ì¼ ë‚´ìš© (ì˜ˆ: ê°œë…ì •ë¦¬, ê¸°ì¶œ 1íšŒ)">
            <input type="date" id="todo-date">
            <button class="btn primary" id="btn-add-todo">ì¶”ê°€</button>
          </div>
          <div id="todo-lists" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">ì¼ì • ë°°ì •</div>
        <div class="body">
          <div class="row">
            <button class="btn success" id="btn-autoplan">ğŸ—“ï¸ ì˜¤ëŠ˜â†’ì‹œí—˜ ë§ˆì§€ë§‰ ë‚  ìë™ ë¶„ë°°</button>
            <button class="btn" id="btn-clearplan">ë°°ì • ì´ˆê¸°í™”</button>
          </div>
          <div class="row" style="margin-top:6px">
            <button class="btn danger" id="btn-reset-all">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
          </div>
          </div>
      </div>
    </div>
  </section>
  <!-- ROUTINE (Everyday planner) -->
  <section id="view-routine" class="hidden">
    <div class="container">
      <div class="card">
        <div class="title">ì¼ìƒ ê³¼ì œ ëª©ë¡</div>
        <div class="body">
          <table class="table" id="routine-task-table">
            <thead><tr><th>ê³¼ëª©</th><th class="left">ì œëª©</th><th>ë‹¨ìœ„ ë¶„</th><th></th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="row" style="margin-top:6px">
            <input class="select" id="r-new-subj" placeholder="ê³¼ëª© (ì˜ˆ: ì˜ì–´)">
            <input class="select" id="r-new-title" placeholder="ì œëª© (ì˜ˆ: ë‹¨ì–´ 30ê°œ)">
            <input class="select" id="r-new-min" type="number" min="5" step="5" placeholder="ë¶„" style="width:120px">
            <button class="btn primary" id="r-btn-task-add">ì¶”ê°€</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="title">ìš”ì¼ë³„ ë°°ì • (on/off)</div>
        <div class="body">
          <table class="table" id="routine-plan-table">
            <thead>
              <tr><th class="left">ê³¼ì œ</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th><th>ì¼</th><th>ì£¼ê°„ í•©ê³„</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
  <!-- SETTINGS -->
  <!-- ì„¤ì • ì„¹ì…˜ ì œê±°ë¨ -->
<!-- section id="view-settings" class="hidden" -->
    <div class="container">
      </div>
      </div>
    </div>
  </section>
<script>
/* ===== Storage & Utils ===== */
const Store = { get(k){try{return localStorage.getItem(k)}catch(e){return null}}, set(k,v){try{localStorage.setItem(k,v)}catch(e){}} };
const KEYs=["midplanner:v6h","midplanner:v6e","midplanner:v6d","midplanner:v6c","midplanner:v6b","midplanner:v6a","midplanner:v6"];
const SAVE_KEY="midplanner:v6h";
function pad(n){return n<10? "0"+n: ""+n}
function fmtDate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}
function getISOWeek(d){ const date=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const dayNum=date.getUTCDay()||7; date.setUTCDate(date.getUTCDate()+4-dayNum); const yearStart=new Date(Date.UTC(date.getUTCFullYear(),0,1)); const weekNo=Math.ceil((((date-yearStart)/86400000)+1)/7); return [date.getUTCFullYear(), weekNo]; }
function weekStartEnd(isoYear, isoWeek){ const simple=new Date(Date.UTC(isoYear,0,4)); const dayOfWeek=simple.getUTCDay()||7; const monday=new Date(simple); monday.setUTCDate(simple.getUTCDate()-dayOfWeek+1+(isoWeek-1)*7); const sunday=new Date(monday); sunday.setUTCDate(monday.getUTCDate()+6); return [monday, sunday]; }
function uid(){ return Math.random().toString(36).slice(2,10) }
function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&gt;","\"":"&quot;","'":"&#39;"}[m])) }
function dateToKDay(ds){
  const d = new Date(ds+"T00:00:00");
  return ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][d.getDay()];
}
function parseLocalDate(ds){
  const [y,m,d] = ds.split('-').map(Number);
  return new Date(y, (m||1)-1, d||1, 0,0,0,0);
}
function isBetweenDates(ds, start, end){
  try{
    const t = parseLocalDate(ds).getTime();
    const s = new Date(start.getFullYear(), start.getMonth(), start.getDate()).getTime();
    const e = new Date(end.getFullYear(), end.getMonth(), end.getDate()).getTime();
    return t>=s && t<=e;
  }catch(e){ return false; }
}
/* ===== Model ===== */
let state={ schedule:[], subjects:[], todos:[], routine:null };
/* ===== Init ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  ensureRewards();
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  document.getElementById('week-range').textContent = `${fmtDate(new Date(ws))} ~ ${fmtDate(new Date(we))}`;
  load(); migrateIfNeeded(state); if(!state.routine) seedRoutine();
  setTab('dashboard'); renderAll();
});
/* ===== Persistence ===== */
function load(){
  let raw=null;
  for(const k of KEYs){ raw = Store.get(k); if(raw){ try{ state=JSON.parse(raw); return; }catch(e){} } }
  state={schedule:[],subjects:[],todos:[],routine:null,rewards:null};
}
function save(){ Store.set(SAVE_KEY, JSON.stringify(state)); }
/* ===== Migration ===== */
function migrateIfNeeded(st){
  if(st && st.routine){
    const r=st.routine;
    if(!r.allocBool && r.alloc){
      r.allocBool={};
      (r.tasks||[]).forEach(t=>{
        r.allocBool[t.id] = {"ì›”":false,"í™”":false,"ìˆ˜":false,"ëª©":false,"ê¸ˆ":false,"í† ":false,"ì¼":false};
        const src = r.alloc?.[t.id];
        if(src){
          for(const d of Object.keys(r.allocBool[t.id])){
            r.allocBool[t.id][d] = (src[d]||0) > 0;
          }
        }
      });
    }
    if(!r.doneDates){ r.doneDates={}; }
    delete r.alloc; delete r.done; delete r.subjects;
  }
  if(!st.subjects) st.subjects=[];
  if(!st.schedule) st.schedule=[];
  if(!st.todos) st.todos=[];
  if(!st.rewards){
    st.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  } else {
    if(typeof st.rewards.badgeCount!=='number') st.rewards.badgeCount = parseInt(st.rewards.badgeCount)||0;
    if(!st.rewards.badgeDates) st.rewards.badgeDates = {};
    if(typeof st.rewards.coupons!=='number') st.rewards.coupons = parseInt(st.rewards.coupons)||0;
  }
}
/* ===== Tabs ===== */
function setTab(name){
  document.querySelectorAll('.tab').forEach(el=> el.classList.toggle('active', el.dataset.action==='tab:'+name));
  document.getElementById('view-dashboard').classList.toggle('hidden', name!=='dashboard');
  document.getElementById('view-exams').classList.toggle('hidden', name!=='exams');
  document.getElementById('view-routine').classList.toggle('hidden', name!=='routine');
  if(name==='dashboard') renderDashboard();
  if(name==='exams') renderScheduleEditor();
  if(name==='routine') renderRoutine();
}
document.body.addEventListener('click',(e)=>{
  const a=e.target.closest('[data-action]'); if(!a) return;
  const act=a.dataset.action;
  if(act?.startsWith('tab:')) setTab(act.split(':')[1]);
  if(act==='export'){
    const out = JSON.stringify(state, null, 2);
    const link=document.createElement('a'); link.href=URL.createObjectURL(new Blob([out],{type:"application/json"}));
    link.download = `midplanner_v6h_${new Date().toISOString().slice(0,10)}.json`; link.click();
  }
});
document.getElementById('import-file').addEventListener('change',(e)=>{
  if(!e.target.files?.length) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ state=JSON.parse(reader.result); migrateIfNeeded(state); save(); renderAll(); renderRoutine(); alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ'); }catch(err){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+err.message);} };
  reader.readAsText(e.target.files[0]);
});
/* ===== Subjects registry (exam) ===== */
function ensureSubject(name){
  name=(name||'').trim(); if(!name) return null;
  let s=state.subjects.find(x=>x.name===name);
  if(!s){ s={id:uid(), name}; state.subjects.push(s); }
  return s.id;
}
function subjectNameById(id){ return state.subjects.find(s=>s.id===id)?.name || id; }
/* ===== Schedule Editor ===== */
function renderScheduleEditor(){
  const tbody=document.querySelector('#schedule-table tbody'); tbody.innerHTML='';
  if(state.schedule.length===0){
    const tr=document.createElement('tr'); tr.innerHTML=`<td colspan="4" class="left">í–‰ì„ ì¶”ê°€í•´ ë‚ ì§œÂ·ê³¼ëª©Â·ë²”ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</td>`; tbody.appendChild(tr);
  }else{
    state.schedule.sort((a,b)=> (a.date||'').localeCompare(b.date||''));
    for(const row of state.schedule){
      const tr=document.createElement('tr');
      const tdDate=document.createElement('td'); tdDate.innerHTML=`<input type="date" value="${row.date||''}">`; 
      const tdSubs=document.createElement('td'); tdSubs.className='left';
      const tdRanges=document.createElement('td'); tdRanges.className='left';
      const tdAct=document.createElement('td');
      const subsWrap=document.createElement('div'); subsWrap.style.padding='0';
      const rangesWrap=document.createElement('div'); rangesWrap.style.padding='0';
      const redrawPairs=()=>{
        subsWrap.innerHTML=''; rangesWrap.innerHTML='';
        if(!row.entries) row.entries=[];
        if(row.entries.length===0){
          subsWrap.innerHTML='<div class="tiny">ê³¼ëª© ì¶”ê°€</div>';
          rangesWrap.innerHTML='<div class="tiny">ë²”ìœ„ ì…ë ¥</div>';
        }
        row.entries.forEach((p)=>{
          const line=document.createElement('div'); line.className='row'; line.style.margin='4px 0';
          line.innerHTML=`<input type="text" value="${escapeHtml(subjectNameById(p.sid))}" placeholder="ê³¼ëª©">`;
          const del=document.createElement('button'); del.className='btn'; del.textContent='ì‚­ì œ';
          line.appendChild(del); subsWrap.appendChild(line);
          const rline=document.createElement('div'); rline.className='row'; rline.style.margin='4px 0';
          rline.innerHTML=`<input type="text" value="${escapeHtml(p.range||'')}" placeholder="ì˜ˆ: ${subjectNameById(p.sid)} 1-2ë‹¨ì›" style="flex:1">`;
          rangesWrap.appendChild(rline);
          const subjInput=line.querySelector('input[type="text"]');
          const rangeInput=rline.querySelector('input[type="text"]');
          subjInput.onchange=()=>{ const sid=ensureSubject(subjInput.value); if(sid) { p.sid=sid; save(); renderAll(); } };
          rangeInput.onchange=()=>{ p.range=rangeInput.value.trim(); save(); renderAll(); };
          del.onclick=()=>{ row.entries = row.entries.filter(x=>x!==p); save(); redrawPairs(); renderAll(); };
        });
      };
      redrawPairs();
      const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='ê³¼ëª© ì¶”ê°€';
      addBtn.onclick=()=>{ row.entries.push({sid: ensureSubject(''), range:''}); save(); redrawPairs(); renderAll(); };
      tdSubs.appendChild(subsWrap); tdAct.appendChild(addBtn);
      tdRanges.appendChild(rangesWrap);
      const delRow=document.createElement('button'); delRow.className='btn danger'; delRow.textContent='í–‰ ì‚­ì œ';
      delRow.onclick=()=>{ state.schedule = state.schedule.filter(x=>x!==row); save(); renderAll(); };
      tdAct.appendChild(delRow);
      tdDate.querySelector('input').onchange=(e)=>{ row.date=e.target.value; save(); renderAll(); };
      tr.appendChild(tdDate); tr.appendChild(tdSubs); tr.appendChild(tdRanges); tr.appendChild(tdAct);
      tbody.appendChild(tr);
    }
  }
  const sel=document.getElementById('todo-subject');
  sel.innerHTML = state.subjects.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
document.getElementById('btn-add-row').addEventListener('click', ()=>{
  state.schedule.push({id:uid(), date:'', entries:[]}); save(); renderAll();
});
document.getElementById('btn-clear-schedule').addEventListener('click', ()=>{
  if(!confirm('ì‹œí—˜ ì¼ì •ì„ ëª¨ë‘ ì§€ìš¸ê¹Œìš”?')) return;
  state.schedule=[]; save(); renderAll();
});
/* ===== Todos CRUD (exam) ===== */
document.getElementById('btn-add-todo').addEventListener('click', ()=>{
  const sid=document.getElementById('todo-subject').value;
  const text=(document.getElementById('todo-text').value||'').trim();
  const date=document.getElementById('todo-date').value||null;
  if(!sid){ alert('ê³¼ëª©ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
  if(!text){ alert('í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  state.todos.push({id:uid(), subjectId:sid, text, plannedDate:date, done:false});
  save(); document.getElementById('todo-text').value=''; document.getElementById('todo-date').value=''; renderAll();
});
function renderTodos(){
  const host=document.getElementById('todo-lists'); host.innerHTML='';
  if(state.subjects.length===0){ host.innerHTML='<div class="tiny">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì¼ì •ì—ì„œ ê³¼ëª©ì„ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”.</div>'; return; }
  state.subjects.forEach(s=>{
    const list=state.todos.filter(t=>t.subjectId===s.id);
    const card=document.createElement('div'); card.className='tcard'; 
    const head=document.createElement('div'); head.className='thead'; head.textContent = `ğŸ“ ${s.name} (${list.filter(x=>x.done).length}/${list.length})`;
    const body=document.createElement('div'); body.className='body'; body.style.padding='6px 0 0';
    if(list.length===0){ body.innerHTML='<div class="tiny">í•  ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
    list.forEach(t=>{
      const row=document.createElement('div'); row.className='tag'+(t.done?' done':'');
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=t.done; ck.onchange=()=>{ t.done=ck.checked; save(); renderDashboard(); };
      const txt=document.createElement('input'); txt.type='text'; txt.value=t.text; txt.style.flex='1';
      txt.onchange=()=>{ t.text=txt.value.trim(); save(); };
      const date=document.createElement('input'); date.type='date'; date.value=t.plannedDate||''; date.onchange=()=>{ t.plannedDate=date.value||null; save(); renderDashboard(); };
      const del=document.createElement('button'); del.className='btn danger'; del.textContent='ì‚­ì œ'; del.onclick=()=>{ state.todos = state.todos.filter(x=>x!==t); save(); renderDashboard(); };
      row.appendChild(ck); row.appendChild(txt); row.appendChild(date); row.appendChild(del);
      body.appendChild(row);
    });
    card.appendChild(head); card.appendChild(body); host.appendChild(card);
  });
}
/* ===== Routine (Everyday planner) ===== */
function seedRoutine(){
  if(!state.rewards){ state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 }; }
  state.routine = {
    tasks:[
      {id:"rvocab",subject:"ì˜ì–´",title:"ì˜ë‹¨ì–´ 30ê°œ",unitMinutes:20},
      {id:"rmath",subject:"ìˆ˜í•™",title:"ë¬¸ì œ 2ì„¸íŠ¸",unitMinutes:30}
    ],
    allocBool:{},
    doneDates:{}
  };
  state.routine.tasks.forEach(t=>{
    state.routine.allocBool[t.id] = {"ì›”":true,"í™”":false,"ìˆ˜":true,"ëª©":false,"ê¸ˆ":true,"í† ":false,"ì¼":false};
    state.routine.doneDates[t.id] = {};
  });
  save();
}
function ensureAllocBool(taskId){
  if(!state.routine.allocBool) state.routine.allocBool={};
  if(!state.routine.allocBool[taskId]) state.routine.allocBool[taskId]={"ì›”":false,"í™”":false,"ìˆ˜":false,"ëª©":false,"ê¸ˆ":false,"í† ":false,"ì¼":false};
}
function ensureDoneDates(taskId){
  if(!state.routine.doneDates) state.routine.doneDates={};
  if(!state.routine.doneDates[taskId]) state.routine.doneDates[taskId]={};
}
function renderRoutine(){
  renderRoutineTasks();
  renderRoutinePlan();
}
function renderRoutineTasks(){
  const tbody=document.querySelector('#routine-task-table tbody'); tbody.innerHTML='';
  state.routine.tasks.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.subject}</td><td class="left">${t.title}</td><td>${t.unitMinutes}</td>`;
    const td=document.createElement('td');
    const edit=document.createElement('button'); edit.className='btn'; edit.textContent='ìˆ˜ì •';
    const del=document.createElement('button'); del.className='btn danger'; del.textContent='ì‚­ì œ'; del.style.marginLeft='6px';
    edit.onclick=()=>{
      const ns=prompt('ê³¼ëª©', t.subject); if(ns===null) return;
      const nt=prompt('ì œëª©', t.title); if(nt===null) return;
      const um=prompt('ë‹¨ìœ„ ë¶„', t.unitMinutes); if(um===null) return;
      t.subject=ns||t.subject; t.title=nt||t.title; t.unitMinutes=parseInt(um)||t.unitMinutes; save(); renderRoutine(); renderDashboard();
    };
    del.onclick=()=>{
      if(state.routine.allocBool) delete state.routine.allocBool[t.id];
      if(state.routine.doneDates) delete state.routine.doneDates[t.id];
      state.routine.tasks = state.routine.tasks.filter(x=>x!==t); save(); renderRoutine(); renderDashboard();
    };
    td.appendChild(edit); td.appendChild(del); tr.appendChild(td); tbody.appendChild(tr);
  });
}
document.getElementById('r-btn-task-add').addEventListener('click', ()=>{
  const subject=(document.getElementById('r-new-subj').value||'').trim();
  const title=(document.getElementById('r-new-title').value||'').trim();
  const unitMinutes=parseInt(document.getElementById('r-new-min').value)||20;
  if(!subject||!title){ alert('ê³¼ëª©/ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const id='r_'+uid();
  const t={id, subject, title, unitMinutes};
  state.routine.tasks.push(t);
  ensureAllocBool(id); ensureDoneDates(id);
  save(); renderRoutine(); renderDashboard();
  document.getElementById('r-new-subj').value=''; document.getElementById('r-new-title').value=''; document.getElementById('r-new-min').value='';
});
function renderRoutinePlan(){
  const tbody=document.querySelector('#routine-plan-table tbody'); tbody.innerHTML='';
  const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  state.routine.tasks.forEach(t=>{
    ensureAllocBool(t.id); ensureDoneDates(t.id);
    const tr=document.createElement('tr');
    const tdTask=document.createElement('td'); tdTask.className='left'; tdTask.innerHTML=`<strong>${t.title}</strong> <span class="small">(${t.subject} Â· ${t.unitMinutes}ë¶„)</span>`;
    tr.appendChild(tdTask);
    let assigned=0;
    days.forEach(d=>{
      const td=document.createElement('td');
      const on = !!state.routine.allocBool[t.id][d];
      if(on) assigned++;
      const btn=document.createElement('button');
      btn.type='button'; btn.className='daybtn'+(on?' on':''); btn.textContent= on ? 'ë°°ì •ë¨' : 'ë°°ì • ì•ˆí•¨';
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      btn.onclick=()=>{ state.routine.allocBool[t.id][d] = !on; save(); renderRoutine(); renderDashboard(); };
      btn.onkeydown=(ev)=>{ if(ev.key==='Enter'||ev.key===' '){ ev.preventDefault(); btn.click(); } };
      td.appendChild(btn); tr.appendChild(td);
    });
    let doneCount=0;
    const doneMap = state.routine.doneDates[t.id] || {};
    Object.keys(doneMap).forEach(ds=>{
      if(doneMap[ds] && isBetweenDates(ds, ws, we)){
        const kd = dateToKDay(ds);
        if(state.routine.allocBool[t.id][kd]) doneCount++;
      }
    });
    const tdSum=document.createElement('td');
    const pct = assigned>0 ? Math.round((doneCount/assigned)*100) : 0;
    tdSum.innerHTML = `<div class="small">ë°°ì • ${assigned} Â· ì™„ë£Œ ${doneCount}</div><div class="minibar"><span style="width:${pct}%"></span></div>`;
    tr.appendChild(tdSum);
    tbody.appendChild(tr);
  });
}
/* ===== Dashboard ===== */
function renderDashboard(){
  const hero=document.getElementById('hero-title');
  const heroSub=document.getElementById('hero-sub');
  const heroBar=document.getElementById('hero-progress');
  const preview=document.getElementById('schedule-preview'); preview.innerHTML='';
  if(state.schedule.length===0){
    hero.textContent='ì‹œí—˜ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ì–´ìš”';
    heroSub.textContent='ì‹œí—˜ ê´€ë¦¬ì—ì„œ ë‚ ì§œë³„ ê³¼ëª©/ë²”ìœ„ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.';
    heroBar.style.width='0%';
  }else{
    const dates = [...new Set(state.schedule.map(r=>r.date).filter(Boolean))].sort();
    const last = dates[dates.length-1];
    const d = dday(last);
    hero.textContent = `ì‹œí—˜ D-${d}`;
    heroSub.textContent = `ì¼ì •: ${dates.join(' Â· ')}`;
    const p = overallProgress();
    heroBar.style.width = Math.round(p)+'%';
    state.schedule.forEach(r=>{
      const card=document.createElement('div'); card.className='tcard';
      const head=document.createElement('div'); head.className='thead'; head.textContent = `${r.date}`;
      const body=document.createElement('div'); body.className='info';
      if(!r.entries || r.entries.length===0){ body.textContent='ê³¼ëª© ì—†ìŒ'; }
      else{
        body.innerHTML = r.entries.map(e=>{
          const name = subjectNameById(e.sid);
          const rg = e.range? ` ${e.range}`:'';
          return `${name}${rg? ' Â· '+rg: ''}`;
        }).join('<br>');
      }
      card.appendChild(head); card.appendChild(body); preview.appendChild(card);
    });
  }
  renderSubjectProgress();
  renderCalendar();
  renderTodayList();
  renderOverall();
  renderTodayBadgeOne();
  renderWeeklySummaryCard();
  // Overdue card render (left column)
  (function(){
    const leftCol = document.querySelector('#view-dashboard .board .col');
    if(leftCol){
      const prev = document.getElementById('card-overdue');
      if(prev) prev.remove();
      leftCol.appendChild(renderOverdueList());
    }
  })();

}
function dday(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((d - today)/(1000*60*60*24));
  return diff>0? diff : 0;
}
function renderSubjectProgress(){
  const host=document.getElementById('subject-progress'); host.innerHTML='';
  if(state.subjects.length===0){ host.innerHTML='<div class="tiny">ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  state.subjects.forEach(s=>{
    const list=state.todos.filter(t=>t.subjectId===s.id);
    const total=list.length; const done=list.filter(t=>t.done).length; const pct= total? Math.round(done/total*100):0;
    const card=document.createElement('div'); card.className='tcard';
    const head=document.createElement('div'); head.className='thead'; head.textContent=`ğŸ¯ ${s.name}`;
    const bar=document.createElement('div'); bar.className='bar'; const span=document.createElement('span'); span.style.width=pct+'%'; bar.appendChild(span);
    const info=document.createElement('div'); info.className='info'; info.textContent=`${done}/${total} (${pct}%)`;
    card.appendChild(head); card.appendChild(bar); card.appendChild(info); host.appendChild(card);
  });
}
function renderCalendar(){
  const host=document.getElementById('calendar'); host.innerHTML='';
  const dates = [...new Set(state.schedule.map(r=>r.date).filter(Boolean))].sort();
  if(dates.length===0){ host.innerHTML='<div class="tiny">ì‹œí—˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
  const today = new Date(); today.setHours(0,0,0,0);
  const end = new Date(dates[dates.length-1]+"T00:00:00");
  if(end<today){ host.innerHTML='<div class="tiny">ë§ˆì§€ë§‰ ì‹œí—˜ì¼ì´ ì˜¤ëŠ˜ë³´ë‹¤ ì´ì „ì…ë‹ˆë‹¤.</div>'; return; }
  const days=[]; for(let d=new Date(today); d<=end; d=new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)){ days.push(fmtDate(d)); }
  const map={}; days.forEach(k=> map[k]=[]);
  state.todos.forEach(t=>{ if(t.plannedDate && map[t.plannedDate]!==undefined) map[t.plannedDate].push({label:`${subjectNameById(t.subjectId)} Â· ${t.text}`, done:t.done, onToggle:(v)=>{ t.done=v; save(); renderDashboard(); }}); });
  days.forEach(date=>{
    const cell=document.createElement('div'); cell.className='cell';
    const head=document.createElement('div'); head.className='head';
    const cntDone=(map[date]||[]).filter(x=>x.done).length; const cntTotal=(map[date]||[]).length;
    head.innerHTML=`<span>${date}</span><span class="tiny">${cntDone}/${cntTotal}</span>`;
    const list=document.createElement('div'); list.className='list';
    (map[date]||[]).forEach(item=>{
      const row=document.createElement('label'); row.className='tag'+(item.done?' done':'');
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=item.done; ck.onchange=()=> item.onToggle(ck.checked);
      const txt=document.createElement('span'); txt.textContent = item.label;
      row.appendChild(ck); row.appendChild(txt); list.appendChild(row);
    });
    cell.appendChild(head); cell.appendChild(list); host.appendChild(cell);
  });
}
function renderTodayList(){
  const host=document.getElementById('today-list'); host.innerHTML='';
  const today=fmtDate(new Date());
  const todayName=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date().getDay()];
  let count=0;
  // exam todos today
  state.todos.filter(t=>t.plannedDate===today).forEach(t=>{
    const row=document.createElement('label'); row.className='tag'+(t.done?' done':'');
    const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=t.done; ck.onchange=()=>{ t.done=ck.checked; save(); renderDashboard(); };
    const txt=document.createElement('span'); txt.textContent = `${subjectNameById(t.subjectId)} Â· ${t.text}`;
    row.appendChild(ck); row.appendChild(txt); host.appendChild(row); count++;
  });
  // routine tasks today
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const on = state.routine.allocBool[t.id][todayName];
      if(on){
        const done = !!state.routine.doneDates[t.id][today];
        const row=document.createElement('label'); row.className='tag'+(done?' done':'');
        const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=done;
        ck.onchange=()=>{ state.routine.doneDates[t.id][today]=ck.checked; save(); renderDashboard(); };
        const txt=document.createElement('span'); txt.textContent = `${t.subject} Â· ${t.title}`;
        row.appendChild(ck); row.appendChild(txt); host.appendChild(row); count++;
      }
    });
  }
  if(count===0){ host.innerHTML='<div class="tiny">ì˜¤ëŠ˜ë¡œ ë°°ì •ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; }
}
function overallProgress(){
  const total=state.todos.length; const done=state.todos.filter(t=>t.done).length;
  return total? (done/total*100) : 0;
}
function renderOverall(){
  const p=overallProgress();
  document.getElementById('overall-bar').style.width=Math.round(p)+'%';
  document.getElementById('overall-text').textContent = `ì „ì²´ ì¤€ë¹„ìœ¨ ${Math.round(p)}%`;
}

function renderTodayBadgeOne(){ ensureRewards(); 
  const host=document.getElementById('today-badge-one'); /*REWARD_TITLE_HOOK*/ host.innerHTML='';
  const stats=document.getElementById('today-stats');
  const today=fmtDate(new Date());
  const todayName=["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][new Date().getDay()];
  let total=0, done=0;
  // count today's exam todos
  state.todos.filter(t=>t.plannedDate===today).forEach(t=>{ total++; if(t.done) done++; });
  // count today's routine
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const on=state.routine.allocBool[t.id][todayName];
      if(on){ total++; if(state.routine.doneDates[t.id][today]) done++; }
    });
  }
  stats.textContent = `${done}/${total} ì™„ë£Œ`;

  // initialize rewards if absent
  if(!state.rewards){
    state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  }

  // If all done today (and at least one exists) and not already rewarded, add a badge
  const achievedToday = (total>0 && done===total);
  if(achievedToday && !state.rewards.badgeDates[today]){
    state.rewards.badgeDates[today] = true;
    state.rewards.badgeCount += 1;
    // Every 50 badges -> 1 coupon
    if(state.rewards.badgeCount % 50 === 0){
      state.rewards.coupons += 1;
      // celebratory chip
      const chip=document.createElement('div'); chip.className='badge-chip'; chip.textContent='ğŸ‰ í”„ë¦¬ë°ì´ ì¿ í° +1';
      host.appendChild(chip);
    }
    save();
  }

  // Stage-based single badge (visual feedback for today)
  let badgeText = "";
  if(total>0 && done===total) badgeText = "ğŸ† ì˜¤ëŠ˜ ëª©í‘œ 100% ë‹¬ì„±";
  else if(done>=5) badgeText = "ğŸš€ 5ê°œ ì™„ë£Œ!";
  else if(done>=3) badgeText = "ğŸ’ª 3ê°œ ëŒíŒŒ";
  else if(done>=1) badgeText = "ğŸ‘ 1ê°œ ì‹œì‘";
  if(badgeText){
    const d=document.createElement('div'); d.className='badge-chip'; d.textContent=badgeText; host.appendChild(d);
  }

  // Persistent counters row (badges & coupons)
  const counter = document.createElement('div');
  counter.className='small';
  counter.style.marginTop='8px';
  counter.textContent = `ëˆ„ì  ì¹­ì°¬ë±ƒì§€ ${state.rewards.badgeCount}ê°œ Â· í”„ë¦¬ë°ì´ ì¿ í° ${state.rewards.coupons}ì¥`;
  host.appendChild(counter);

  // Coupon use button
  const btnWrap = document.createElement('div');
  btnWrap.style.marginTop='6px';
  const useBtn = document.createElement('button');
  useBtn.className = 'btn ' + (state.rewards.coupons>0 ? 'warn' : '');
  useBtn.disabled = state.rewards.coupons<=0;
  useBtn.textContent = state.rewards.coupons>0 ? 'ğŸ« í”„ë¦¬ë°ì´ ì¿ í° ì‚¬ìš©' : 'ì¿ í° ì—†ìŒ';
  useBtn.onclick = ()=>{
    if(state.rewards.coupons>0){
      if(confirm('í”„ë¦¬ë°ì´ ì¿ í° 1ì¥ì„ ì‚¬ìš©í• ê¹Œìš”?')){
        state.rewards.coupons -= 1;
        save();
        renderTodayBadgeOne();
        alert('ì¿ í° 1ì¥ì„ ì‚¬ìš©í–ˆì–´ìš”!');
      }
    }
  };
  btnWrap.appendChild(useBtn);
  host.appendChild(btnWrap);

}
function renderWeeklySummaryCard(){
  const bar=document.getElementById('weekly-bar');
  const txt=document.getElementById('weekly-text');
  const list=document.getElementById('weekly-list');
  list.innerHTML='';
  const [y,w]=getISOWeek(new Date());
  const [ws,we]=weekStartEnd(y,w);
  const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];
  let totalAssigned=0, totalDone=0;
  if(state.routine){
    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      const assigned = days.reduce((acc,d)=> acc + (state.routine.allocBool[t.id][d]?1:0), 0);
      totalAssigned += assigned;
      let done=0;
      const dm = state.routine.doneDates[t.id] || {};
      Object.keys(dm).forEach(ds=>{
        if(dm[ds] && isBetweenDates(ds, ws, we)){
          const kd = dateToKDay(ds);
          if(state.routine.allocBool[t.id][kd]) done++;
        }
      });
      totalDone += done;
      const card=document.createElement('div'); card.className='tcard';
      const head=document.createElement('div'); head.className='thead'; head.textContent = `${t.subject} Â· ${t.title}`;
      const info=document.createElement('div'); info.className='info'; info.textContent = `ë°°ì • ${assigned} Â· ì™„ë£Œ ${done}`;
      const pct = assigned>0 ? Math.round((done/assigned)*100) : 0;
      const barMini=document.createElement('div'); barMini.className='minibar'; const span=document.createElement('span'); span.style.width=pct+'%'; barMini.appendChild(span);
      card.appendChild(head); card.appendChild(info); card.appendChild(barMini);
      list.appendChild(card);
    });
  }
  const pctAll = totalAssigned>0 ? Math.round((totalDone/totalAssigned)*100) : 0;
  bar.style.width = pctAll+'%';
  txt.textContent = `ë°°ì • ${totalAssigned} Â· ì™„ë£Œ ${totalDone}`;
}

/* ========= NEW: Overdue (ì‹œí—˜+ì¼ìƒ) íƒ­ í†µí•© ========= */
function renderOverdueList(){
  const card=document.createElement('div');
  card.className='card';
  card.id='card-overdue';
  const title=document.createElement('div');
  title.className='title';

  const today=fmtDate(new Date());
  // 1) ì‹œí—˜ overdue (plannedDate < today && !done)
  const examOverdue=state.todos
    .filter(t=>t.plannedDate && t.plannedDate<today && !t.done)
    .sort((a,b)=> (a.plannedDate||'').localeCompare(b.plannedDate||''));

  // 2) ì¼ìƒ overdue (ì´ë²ˆ ì£¼ ì›”ìš”ì¼~ì–´ì œ ì‚¬ì´ì˜ ë°°ì • onì¸ë° done ì—†ìŒ)
  const routineOverdue=[];
  if(state.routine){
    const days=["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];
    const now=new Date();
    const [y,w]=getISOWeek(now);
    const [ws,we]=weekStartEnd(y,w); // ws = ì›”ìš”ì¼(UTC ê¸°ì¤€) â†’ ë¡œì»¬ ë³´ì • ìœ„í•´ ê·¸ëŒ€ë¡œ ë‚ ì§œ ë¬¸ìì—´ë§Œ ì‚¬ìš©

    // í•´ë‹¹ ì£¼ì˜ ê° ìš”ì¼ ë‚ ì§œ ë¬¸ìì—´ ë§¤í•‘
    const dayToDate={};
    for(let i=0;i<7;i++){
      const d=new Date(ws); d.setUTCDate(ws.getUTCDate()+i);
      dayToDate[days[i]] = fmtDate(new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()));
    }
    const todayIdx = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][now.getDay()];
    const idxOf = (nm)=> days.indexOf(nm);
    const cutoff = idxOf(todayIdx); // ì˜¤ëŠ˜ ì´ì „ë§Œ

    state.routine.tasks.forEach(t=>{
      ensureAllocBool(t.id); ensureDoneDates(t.id);
      for(let i=0;i<cutoff;i++){
        const kday=days[i];
        if(state.routine.allocBool[t.id][kday]){
          const ds=dayToDate[kday];
          const done = !!state.routine.doneDates[t.id][ds];
          if(!done){
            routineOverdue.push({
              taskId:t.id,
              label:`${t.subject} Â· ${t.title}`,
              plannedDate: ds,
              kday: kday
            });
          }
        }
      }
    });
    routineOverdue.sort((a,b)=> a.plannedDate.localeCompare(b.plannedDate));
  }

  const totalCount = examOverdue.length + routineOverdue.length;
  title.innerHTML = `â° ë°€ë¦° í•  ì¼ ${totalCount? `<span class="badge">${totalCount}ê±´</span>`:''}`;
  const body=document.createElement('div');
  body.className='body';

  // íƒ­ ë²„íŠ¼
  const pills=document.createElement('div'); pills.className='pilltabs';
  const pExam=document.createElement('button'); pExam.type='button'; pExam.className='pill active'; pExam.textContent = `ì‹œí—˜ (${examOverdue.length})`;
  const pRoutine=document.createElement('button'); pRoutine.type='button'; pRoutine.className='pill'; pRoutine.textContent = `ì¼ìƒ (${routineOverdue.length})`;
  pills.appendChild(pExam); pills.appendChild(pRoutine);
  body.appendChild(pills);
  body.appendChild(document.createElement('div')).className='sep';

  // ì»¨í…Œì´ë„ˆ
  const listWrap=document.createElement('div');
  body.appendChild(listWrap);

  function renderTab(which){
    listWrap.innerHTML='';
    const arr = which==='exam' ? examOverdue : routineOverdue;
    if(arr.length===0){ listWrap.innerHTML = '<div class="tiny">ë°€ë¦° í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    arr.forEach(item=>{
      const row=document.createElement('label'); row.className='tag';
      const ck=document.createElement('input'); ck.type='checkbox'; ck.checked=false;
      const span=document.createElement('span');
      if(which==='exam'){
        const subj = subjectNameById(item.subjectId);
        span.textContent = `${subj} Â· ${item.text} (${item.plannedDate})`;
        ck.onchange=()=>{ item.done=true; const t=state.todos.find(x=>x.id===item.id || (x.subjectId===item.subjectId && x.text===item.text && x.plannedDate===item.plannedDate)); if(t){ t.done=true; save(); renderDashboard(); } };
      }else{
        span.textContent = `${item.label} (${item.kday} Â· ${item.plannedDate})`;
        ck.onchange=()=>{ const m = state.routine.doneDates[item.taskId]||{}; m[item.plannedDate]=true; state.routine.doneDates[item.taskId]=m; save(); renderDashboard(); };
      }
      row.appendChild(ck); row.appendChild(span); listWrap.appendChild(row);
    });
  }
  renderTab('exam');
  pExam.onclick=()=>{ pExam.classList.add('active'); pRoutine.classList.remove('active'); renderTab('exam'); };
  pRoutine.onclick=()=>{ pRoutine.classList.add('active'); pExam.classList.remove('active'); renderTab('routine'); };

  card.appendChild(title);
  card.appendChild(body);
  return card;
}

/* ===== Settings ===== */
/* ===== Helpers ===== */

function ensureRewards(){
  if(!state.rewards || typeof state.rewards!=='object'){
    state.rewards = { badgeCount: 0, badgeDates: {}, coupons: 0 };
  }
  if(typeof state.rewards.badgeCount!=='number' || isNaN(state.rewards.badgeCount)) state.rewards.badgeCount = 0;
  if(!state.rewards.badgeDates || typeof state.rewards.badgeDates!=='object') state.rewards.badgeDates = {};
  if(typeof state.rewards.coupons!=='number' || isNaN(state.rewards.coupons)) state.rewards.coupons = 0;
}

function dday(dateStr){
  const d = new Date(dateStr+"T00:00:00");
  const today = new Date(); today.setHours(0,0,0,0);
  const diff = Math.ceil((d - today)/(1000*60*60*24));
  return diff>0? diff : 0;
}
function renderAll(){ ensureRewards();  renderScheduleEditor(); renderTodos(); renderDashboard(); }

// attach reset handler if button exists (exams page only)
(function(){
  const __resetBtn = document.getElementById('btn-reset-all');
  if(__resetBtn){
    __resetBtn.addEventListener('click', ()=>{
      if(!confirm('ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
      KEYs.forEach(k=> localStorage.removeItem(k));
      state={schedule:[], subjects:[], todos:[], routine:null}; seedRoutine(); renderAll();
    });
  }
})();
</script>
</body>
</html>
